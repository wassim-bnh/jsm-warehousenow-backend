name: Cache Refresh

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual refresh'
        required: false
        default: 'Manual cache refresh'

jobs:
  refresh-cache:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Refresh Cache
      run: |
        echo "🔄 Starting cache refresh at $(date)"
        echo "API URL: ${{ secrets.API_URL }}"

        # Make the cache refresh request
        response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.API_URL }}/cache/refresh")
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | head -n -1)
        
        echo "Response status: $http_code"
        echo "Response body: $body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "✅ Cache refreshed successfully"
        else
          echo "❌ Cache refresh failed with status: $http_code"
          exit 1
        fi
        
    - name: Verify Cache Status
      run: |
        echo "🔍 Checking cache status..."
        status_response=$(curl -s -X GET "${{ secrets.API_URL }}/cache/status")
        echo "Cache status: $status_response"
        
    - name: Notify on Success
      if: success()
      run: |
        echo "🎉 Cache refresh completed successfully at $(date)"
      
    - name: Notify on Failure
      if: failure()
      run: |
        echo "💥 Cache refresh failed at $(date)"
